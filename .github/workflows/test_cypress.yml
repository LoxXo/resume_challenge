name: Cypress E2E Tests for API and Webpage

on:
  # workflow_call:
  workflow_dispatch:
  workflow_run:
    workflows: [Azure Static Web Apps Webpage CI/CD]
    types:
      - completed


jobs:
  install:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-22.04
    steps:
      - name: Sleep for 1 minutes           
        uses: jakejarvis/wait-action@v0.1.1
        with:
          time: '1m'
          
      - name: Checkout
        uses: actions/checkout@v4

      - name: Cypress install
        uses: cypress-io/github-action@v6
        with:
            # Disable running of tests within install job
            runTests: false
            working-directory: ./tests
            build: npm install --verbose

      - name: Save node_modules folder
        uses: actions/upload-artifact@v4
        with:
          name: node_modules
          if-no-files-found: error
          path: node_modules
          
  cypress-run:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-22.04
    steps:
      - name: Sleep for 2 minutes           
        uses: jakejarvis/wait-action@v0.1.1
        with:
          time: '2m'

      - name: Checkout
        uses: actions/checkout@v4

      - name: Download the node_modules folder
        uses: actions/download-artifact@v4
        with:
          name: node_modules
          path: node_modules

      - name: Cypress run
        uses: cypress-io/github-action@v6
        with:
          spec: 'cypress/e2e/resume_page_live.cy.js'
          start: npm start
          browser: chrome
